name: Create Electron Installations
on:
  push:
    tags:
      - v*

jobs:
  windows:
    name: Create the Windows Installation
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Setup Node
        uses: actions/setup-node@v2-beta

      - name: Set backend environment
        run: |
          cd $env:GITHUB_WORKSPACE/backend
          pip install --upgrade pip
          pip install t2wml-api
          pip install -r requirements.txt
          pip install pyinstaller pywin32 semver
      - name: Create installer
        env:  # Replace unicode characters with ?
          PYTHONIOENCODING: :replace
          PYTHONLEGACYWINDOWSIOENCODING: true
          CI: false   # Otherwise React stops on warnings
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          $env.CSC_LINK="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"
          cd $env:GITHUB_WORKSPACE/backend
          python packaging/prepare_installation.py --version ${{ github.ref }}
      - name: Rename installer to canonical name
        run: |
          cd $env:GITHUB_WORKSPACE/electron/out
          copy "t2wml Setup*.exe" t2wml-setup.exe
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
        shell: bash
      - name: Upload to Release
        id: upload-release-asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: electron/out/t2wml-setup.exe
          asset_name: t2wml-setup-${{ steps.get_version.outputs.VERSION }}.exe
          tag: ${{ github.ref }}
          overwrite: true
          body: "Windows Executable"
  mac:
    name: Create the Mac OS Installation
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Setup Node
        uses: actions/setup-node@v2-beta
      - name: Set backend environment
        run: |
          cd $GITHUB_WORKSPACE/backend
          pip install --upgrade setuptools pip
          pip install t2wml-api
          pip install -r requirements.txt
          pip install pyinstaller semver
      - name: Create executable
        env:
          CI: false   # Otherwise React stops on warnings
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          cd $GITHUB_WORKSPACE/backend
          python packaging/prepare_installation.py --version ${{ github.ref }}
      - name: Rename installer to canonical name
        run: |
          cd $GITHUB_WORKSPACE/electron/out
          ls -l
          cp t2wml*.pkg t2wml.pkg

      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}

      - name: Upload to Release
        id: upload-release-asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: electron/out/t2wml.pkg
          asset_name: t2wml-${{ steps.get_version.outputs.VERSION }}.pkg
          tag: ${{ github.ref }}
          overwrite: true
          body: "MacOS Executable"
  linux:
    name: Create the Linux Installation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Setup Node
        uses: actions/setup-node@v2-beta

      - name: Set backend environment
        run: |
          cd $GITHUB_WORKSPACE/backend
          pip install --upgrade setuptools pip
          pip install t2wml-api
          pip install -r requirements.txt
          pip install pyinstaller semver
      - name: Create executable
        env:
          CI: false   # Otherwise React stops on warnings
        run: |
          cd $GITHUB_WORKSPACE/backend
          python packaging/prepare_installation.py --version ${{ github.ref }}
      - name: Rename installer to canonical name
        run: |
          cd $GITHUB_WORKSPACE/electron/out
          cp t2wml*.AppImage t2wml.AppImage
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
      - name: Upload to Release
        id: upload-release-asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: electron/out/t2wml.AppImage
          asset_name: t2wml-${{ steps.get_version.outputs.VERSION }}.AppImage
          tag: ${{ github.ref }}
          overwrite: true
          body: "Linux Executable"

